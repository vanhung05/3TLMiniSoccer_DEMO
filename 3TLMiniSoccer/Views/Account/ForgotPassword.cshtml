@{
    ViewData["Title"] = "Quên mật khẩu - 3TL Mini Soccer";
    ViewData["Description"] = "Khôi phục mật khẩu tài khoản 3TL Mini Soccer một cách nhanh chóng và an toàn";
}

@section Styles {
    <style>
        .form-input {
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(22, 163, 74, 0.3);
        }
        
        .floating-label {
            position: relative;
        }
        
        .floating-label input:focus + label,
        .floating-label input:not(:placeholder-shown) + label {
            transform: translateY(-1.5rem) scale(0.85);
            color: #16a34a;
        }
        
        .floating-label label {
            position: absolute;
            left: 1rem;
            top: 1rem;
            transition: all 0.3s ease;
            pointer-events: none;
            color: #6b7280;
        }
        
        .step-indicator {
            position: relative;
        }
        
        .step-indicator::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            width: 100%;
            height: 2px;
            background-color: #e5e7eb;
            transform: translateY(-50%);
        }
        
        .step-indicator:last-child::after {
            display: none;
        }
        
        .step-indicator.active::after {
            background-color: #16a34a;
        }
        
        .step-indicator.completed::after {
            background-color: #16a34a;
        }
        
        .success-animation {
            animation: successPulse 2s ease-in-out;
        }
        
        @@keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
}

<!-- Forgot Password Section -->
<section class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8" data-aos="fade-up">
        <div class="text-center">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Quên mật khẩu?</h2>
            <p class="text-gray-600">Đừng lo lắng, chúng tôi sẽ giúp bạn khôi phục tài khoản</p>
        </div>
        
        <!-- Step Indicator -->
        <div class="flex items-center justify-center space-x-4 mb-8">
            <div class="step-indicator active flex items-center">
                <div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-sm font-medium">1</div>
                <span class="ml-2 text-sm font-medium text-primary">Nhập email</span>
            </div>
            <div class="step-indicator flex items-center">
                <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-medium">2</div>
                <span class="ml-2 text-sm font-medium text-gray-500">Xác thực</span>
            </div>
            <div class="step-indicator flex items-center">
                <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-medium">3</div>
                <span class="ml-2 text-sm font-medium text-gray-500">Đặt lại mật khẩu</span>
            </div>
        </div>
        
        <!-- Step 1: Enter Email -->
        <div id="step1" class="bg-white rounded-xl shadow-lg p-8">
            <form class="space-y-6" id="forgotPasswordForm" asp-controller="Account" asp-action="ForgotPassword" method="post">
                @Html.AntiForgeryToken()
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-primary bg-opacity-10 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Nhập email của bạn</h3>
                    <p class="text-gray-600 text-sm">Chúng tôi sẽ gửi link khôi phục mật khẩu đến email này</p>
                </div>
                
                <div class="floating-label">
                    <input 
                        id="email" 
                        name="email" 
                        type="email" 
                        placeholder=" "
                        class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        required
                    >
                    <label for="email">Email đăng ký</label>
                </div>
                
                <button 
                    type="submit" 
                    class="btn-primary w-full py-3 px-4 rounded-lg text-white font-medium text-lg"
                >
                    Gửi link khôi phục
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-gray-600 text-sm">
                    Nhớ mật khẩu rồi? 
                    <a asp-controller="Account" asp-action="Login" class="text-primary hover:text-green-700 font-medium transition">
                        Đăng nhập ngay
                    </a>
                </p>
            </div>
        </div>
        
        <!-- Step 2: Verification Code -->
        <div id="step2" class="bg-white rounded-xl shadow-lg p-8 hidden">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-primary bg-opacity-10 rounded-full flex items-center justify-center mx-auto mb-4 success-animation">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 12l2 2 4-4"></path>
                        <circle cx="12" cy="12" r="10"></circle>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Kiểm tra email của bạn</h3>
                <p class="text-gray-600 text-sm">Chúng tôi đã gửi mã xác thực 6 số đến email <span id="userEmail" class="font-medium text-primary"></span></p>
            </div>
            
            <form class="space-y-6" id="verificationForm">
                <div class="flex justify-center space-x-2">
                    <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                    <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                
                <div class="text-center">
                    <p class="text-sm text-gray-500 mb-2">Không nhận được mã?</p>
                    <button type="button" id="resendCode" class="text-primary hover:text-green-700 font-medium text-sm transition">
                        Gửi lại mã (60s)
                    </button>
                </div>
                
                <button 
                    type="submit" 
                    class="btn-primary w-full py-3 px-4 rounded-lg text-white font-medium text-lg"
                >
                    Xác thực mã
                </button>
            </form>
        </div>
        
        <!-- Step 3: Reset Password -->
        <div id="step3" class="bg-white rounded-xl shadow-lg p-8 hidden">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-primary bg-opacity-10 rounded-full flex items-center justify-center mx-auto mb-4 success-animation">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <circle cx="12" cy="16" r="1"></circle>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Đặt lại mật khẩu mới</h3>
                <p class="text-gray-600 text-sm">Nhập mật khẩu mới cho tài khoản của bạn</p>
            </div>
            
            <form class="space-y-6" id="resetPasswordForm">
                <div class="floating-label">
                    <input 
                        id="newPassword" 
                        name="newPassword" 
                        type="password" 
                        placeholder=" "
                        class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        required
                    >
                    <label for="newPassword">Mật khẩu mới</label>
                </div>
                
                <div class="floating-label">
                    <input 
                        id="confirmNewPassword" 
                        name="confirmNewPassword" 
                        type="password" 
                        placeholder=" "
                        class="form-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        required
                    >
                    <label for="confirmNewPassword">Xác nhận mật khẩu mới</label>
                </div>
                
                <!-- Password Requirements -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-gray-900 mb-2">Yêu cầu mật khẩu:</h4>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li class="flex items-center">
                            <span class="w-2 h-2 bg-gray-300 rounded-full mr-2"></span>
                            Ít nhất 8 ký tự
                        </li>
                        <li class="flex items-center">
                            <span class="w-2 h-2 bg-gray-300 rounded-full mr-2"></span>
                            Có chữ hoa và chữ thường
                        </li>
                        <li class="flex items-center">
                            <span class="w-2 h-2 bg-gray-300 rounded-full mr-2"></span>
                            Có ít nhất 1 số
                        </li>
                        <li class="flex items-center">
                            <span class="w-2 h-2 bg-gray-300 rounded-full mr-2"></span>
                            Có ít nhất 1 ký tự đặc biệt
                        </li>
                    </ul>
                </div>
                
                <button 
                    type="submit" 
                    class="btn-primary w-full py-3 px-4 rounded-lg text-white font-medium text-lg"
                >
                    Đặt lại mật khẩu
                </button>
            </form>
        </div>
        
        <!-- Success Message -->
        <div id="successMessage" class="bg-white rounded-xl shadow-lg p-8 text-center hidden">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 success-animation">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 12l2 2 4-4"></path>
                    <circle cx="12" cy="12" r="10"></circle>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Thành công!</h3>
            <p class="text-gray-600 mb-6">Mật khẩu của bạn đã được đặt lại thành công. Bạn có thể đăng nhập với mật khẩu mới.</p>
            <a asp-controller="Account" asp-action="Login" class="btn-primary inline-block py-3 px-6 rounded-lg text-white font-medium transition">
                Đăng nhập ngay
            </a>
        </div>
        
        <!-- Help Section -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="font-semibold text-gray-900 mb-4">Cần hỗ trợ?</h3>
            <div class="space-y-3">
                <div class="flex items-start">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 mt-0.5">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-gray-900">Không nhận được email?</p>
                        <p class="text-sm text-gray-600">Kiểm tra thư mục spam hoặc liên hệ hotline: 0901 234 567</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 mt-0.5">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-gray-900">Gọi hỗ trợ trực tiếp</p>
                        <p class="text-sm text-gray-600">Hotline: 0901 234 567 (8h-22h hàng ngày)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        // Step management
        let currentStep = 1;
        let userEmail = '';
        let resendTimer = 60;
        let resendInterval;
        
        function updateStepIndicator(step) {
            const indicators = document.querySelectorAll('.step-indicator');
            indicators.forEach((indicator, index) => {
                const stepNumber = indicator.querySelector('div');
                const stepText = indicator.querySelector('span');
                
                if (index + 1 < step) {
                    indicator.classList.add('completed');
                    stepNumber.textContent = '✓';
                    stepNumber.classList.remove('bg-gray-300', 'text-gray-600');
                    stepNumber.classList.add('bg-primary', 'text-white');
                    stepText.classList.remove('text-gray-500');
                    stepText.classList.add('text-primary');
                } else if (index + 1 === step) {
                    indicator.classList.add('active');
                    stepNumber.textContent = index + 1;
                    stepNumber.classList.remove('bg-gray-300', 'text-gray-600');
                    stepNumber.classList.add('bg-primary', 'text-white');
                    stepText.classList.remove('text-gray-500');
                    stepText.classList.add('text-primary');
                } else {
                    indicator.classList.remove('active', 'completed');
                    stepNumber.textContent = index + 1;
                    stepNumber.classList.remove('bg-primary', 'text-white');
                    stepNumber.classList.add('bg-gray-300', 'text-gray-600');
                    stepText.classList.remove('text-primary');
                    stepText.classList.add('text-gray-500');
                }
            });
        }
        
        function showStep(step) {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
            
            document.getElementById(`step${step}`).classList.remove('hidden');
            updateStepIndicator(step);
        }
        
        // Step 1: Email submission
        document.getElementById('forgotPasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            
            if (!email) {
                alert('Vui lòng nhập email');
                return;
            }
            
            userEmail = email;
            document.getElementById('userEmail').textContent = email;
            
            // Send request to server
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            submitBtn.textContent = 'Đang gửi...';
            submitBtn.disabled = true;
            
            // Create form data
            const formData = new FormData();
            formData.append('email', email);
            
            fetch('@Html.Raw(Url.Action("ForgotPassword", "Account"))', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentStep = 2;
                    showStep(2);
                    startResendTimer();
                } else {
                    alert(data.message || 'Có lỗi xảy ra, vui lòng thử lại');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra, vui lòng thử lại');
            })
            .finally(() => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });
        
        // Step 2: Verification code
        document.getElementById('verificationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const inputs = this.querySelectorAll('input[type="text"]');
            const code = Array.from(inputs).map(input => input.value).join('');
            
            if (code.length !== 6) {
                alert('Vui lòng nhập đầy đủ 6 số');
                return;
            }
            
            // Send verification request
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            submitBtn.textContent = 'Đang xác thực...';
            submitBtn.disabled = true;
            
            const formData = new FormData();
            formData.append('code', code);
            
            fetch('@Html.Raw(Url.Action("VerifyResetCode", "Account"))', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentStep = 3;
                    showStep(3);
                } else {
                    alert(data.message || 'Mã xác thực không hợp lệ');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra, vui lòng thử lại');
            })
            .finally(() => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });
        
        // Step 3: Reset password
        document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            
            if (!newPassword || !confirmPassword) {
                alert('Vui lòng điền đầy đủ thông tin');
                return;
            }
            
            if (newPassword.length < 8) {
                alert('Mật khẩu phải có ít nhất 8 ký tự');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('Mật khẩu xác nhận không khớp');
                return;
            }
            
            // Send password reset request
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            submitBtn.textContent = 'Đang cập nhật...';
            submitBtn.disabled = true;
            
            const formData = new FormData();
            formData.append('newPassword', newPassword);
            formData.append('confirmPassword', confirmPassword);
            
            fetch('@Html.Raw(Url.Action("ResetPassword", "Account"))', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('step3').classList.add('hidden');
                    document.getElementById('successMessage').classList.remove('hidden');
                } else {
                    alert(data.message || 'Có lỗi xảy ra, vui lòng thử lại');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra, vui lòng thử lại');
            })
            .finally(() => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });
        
        // Resend timer
        function startResendTimer() {
            resendTimer = 60;
            const resendBtn = document.getElementById('resendCode');
            
            resendInterval = setInterval(() => {
                resendBtn.textContent = `Gửi lại mã (${resendTimer}s)`;
                resendTimer--;
                
                if (resendTimer < 0) {
                    clearInterval(resendInterval);
                    resendBtn.textContent = 'Gửi lại mã';
                    resendBtn.onclick = function() {
                        startResendTimer();
                        // Simulate resending
                        alert('Mã xác thực mới đã được gửi!');
                    };
                }
            }, 1000);
        }
        
        // OTP input handling
        document.querySelectorAll('#verificationForm input[type="text"]').forEach((input, index, inputs) => {
            input.addEventListener('input', function() {
                if (this.value.length === 1 && index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }
            });
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && this.value === '' && index > 0) {
                    inputs[index - 1].focus();
                }
            });
        });
        
        // Auto-focus first input
        document.getElementById('email').focus();
    </script>
}
